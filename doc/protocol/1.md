# Janus Protocol Version 1

2025-12-19

## Protocol Model

Janus Protocol is a special type of Vesper Control Protocol, which is a simple binary protocol with very thin header.

## Endianness

Network byte order defined by TCP/IP is used. So all multi-byte integers in the protocol is in big-endian. Note that integers in binary data blocks, or where explicitly specified, may not follow this general rule.

## Header

Every message begins with a header like this:

```
    4B        4B
+---------+---------+
|  magic  |  type   |
+---------+---------+
|       length      |
+-------------------+
```

* magic (int32): Fixed. ASCII: `jANu`
* type (int32): Command identifier. Continue reading to learn more.
* length (int64): Size of the message without header.

**Altough we have int64 for length, you should still limit your body size to 1GB since platforms like JVM cannot handle large messages properly.**

## Protocol Magic

Protocol magic is set to `jANu`

## Protocol Messages

### 0xA001: Common Response

From: Protocol Version 1

```
  8 Bytes
+-------------------+
|                   |
+       header      +
|                   |
+---------+---------+
|  code   | msg len |
+---------+---------+
|      msg          |
|      ...          |

```

* type (int32): `0xA001`
* code (int32): Status code. 0 for OK.
* msg len (int32): Size of `msg` in Bytes. **If `code` is 0, this value should be ignored.**
* msg (byte array): Data returned.

Response can be used to transfer data. When `code` is not 0, `msg` should be treated as error log. When `code` is 0, `msg`'s meaning differs to their type.

**Error log is NOT null-terminated.**

---

### 0x1000: Hello

Supported by any protocol version.

For:

* Client to Server

Used to tell other which protocol version it supports.

```
+-------------------+
|                   |
+       header      +
|                   |
+---------+---------+
| my protocol ver 1 |
+-------------------+
| my protocol ver 2 |
+-------------------+
|       ......      |
+-------------------+
| my protocol ver n |
+-------------------+
```

If server rejects this client, send a `Hello` with no protocol version.

If server accepts this client, send a `Hello` message with its protocol versions.

Then, client should response another `Hello` with only one protocol version chosen for this connection.

Any toxic behaviours could lead to server closing the connection.

Whole procedure:

```
Server                Client
----------------------------
== Connection Established ==
  
        Versions supported
           by client
         <----------

        Versions supported
           by server
         ---------> 

        Protocol version
        for this connection
         <----------
```

Note that the `versions supported by the server` should be a subset of the `versions supported by the client`.

---

### 0x1001: Auth

From: Protocol Version 1

For:

* Client to Server

```
  8 Bytes
+-------------------+
|                   |
+       header      +
|                   |
+---------+---------+
|      challenge    |
|        ...        |
```

`challenge` is a byte array (might be a text string but not promised).

**Step1**

Client send workspace name it wants to connect.

**Step2**

Server send `Auth` to receiver.

**Step3**

Receiver should encrypt it using its AES key and send it back using a `Response` message, putting it inside the `msg` field.

**Step4**

If authorized, server should send a response with code 0.

If deny, server should send a response with code which is not 0.

```
Server                Client
----------------------------
== Connection Established ==

==     Hello Greeings     ==

Workspace name (placed in challenge)
         <--------- step 1
  
    Auth (with plain text)
         ----------> step 2

  Response with encrypted content
         <--------- step 3

 Response with accept or deny
         ----------> step 4

==      Ready to Serve    ==

```

If workspace not exists, auth will still proceed but response will be set to `denied`.

---

### 0x1801: GetSystemTimeMillis

From: Protocol Version 1

For:

* Client to Server

```
  8 Bytes
+-------------------+
|                   |
+       header      +
|                   |
+---------+---------+
```

Response body is a 64-bit integer, indicating server's current time in milliseconds.

---

### 0x2001: FetchFileTree

From: Protocol Version 1

For:

* Client to Server

```
  8 Bytes
+-------------------+
|                   |
+       header      +
|                   |
+---------+---------+
```

Response is a ProtoBuf message. Can be decoded to Janus FileTree structure.

---

### 0x2002: CommitSyncPlan

From: Protocol Version 1

For:

* Client to Server

This msssage may modify server's file tree.

```
  8 Bytes
+-------------------+
|                   |
+       header      +
|                   |
+---------+---------+
|   Plan 0 size     |
+---------+---------+
|                   |
|   Plan 0 Bytes    |
|                   |
+---------+---------+
|   Plan 1 size     |
+---------+---------+
|                   |
|   Plan 1 Bytes    |
|                   |
+---------+---------+
|       ...         |
|                   |
```

Each SyncPlan is a protobuf-encoded message.

Server will proceed the plan if it doesn't contains malicious instructions (like path traversal).


